/*
  Ported to JavaScript by Lazar Laszlo 2011 
  
  lazarsoft@gmail.com, www.lazarsoft.info
  
*/

/*
*
* Copyright 2007 ZXing authors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function PerspectiveTransform(e,t,n,r,i,s,o,u,a){this.a11=e;this.a12=r;this.a13=o;this.a21=t;this.a22=i;this.a23=u;this.a31=n;this.a32=s;this.a33=a;this.transformPoints1=function(e){var t=e.length;var n=this.a11;var r=this.a12;var i=this.a13;var s=this.a21;var o=this.a22;var u=this.a23;var a=this.a31;var f=this.a32;var l=this.a33;for(var c=0;c<t;c+=2){var h=e[c];var p=e[c+1];var d=i*h+u*p+l;e[c]=(n*h+s*p+a)/d;e[c+1]=(r*h+o*p+f)/d}};this.transformPoints2=function(e,t){var n=e.length;for(var r=0;r<n;r++){var i=e[r];var s=t[r];var o=this.a13*i+this.a23*s+this.a33;e[r]=(this.a11*i+this.a21*s+this.a31)/o;t[r]=(this.a12*i+this.a22*s+this.a32)/o}};this.buildAdjoint=function(){return new PerspectiveTransform(this.a22*this.a33-this.a23*this.a32,this.a23*this.a31-this.a21*this.a33,this.a21*this.a32-this.a22*this.a31,this.a13*this.a32-this.a12*this.a33,this.a11*this.a33-this.a13*this.a31,this.a12*this.a31-this.a11*this.a32,this.a12*this.a23-this.a13*this.a22,this.a13*this.a21-this.a11*this.a23,this.a11*this.a22-this.a12*this.a21)};this.times=function(e){return new PerspectiveTransform(this.a11*e.a11+this.a21*e.a12+this.a31*e.a13,this.a11*e.a21+this.a21*e.a22+this.a31*e.a23,this.a11*e.a31+this.a21*e.a32+this.a31*e.a33,this.a12*e.a11+this.a22*e.a12+this.a32*e.a13,this.a12*e.a21+this.a22*e.a22+this.a32*e.a23,this.a12*e.a31+this.a22*e.a32+this.a32*e.a33,this.a13*e.a11+this.a23*e.a12+this.a33*e.a13,this.a13*e.a21+this.a23*e.a22+this.a33*e.a23,this.a13*e.a31+this.a23*e.a32+this.a33*e.a33)}}function DetectorResult(e,t){this.bits=e;this.points=t}function Detector(e){this.image=e;this.resultPointCallback=null;this.sizeOfBlackWhiteBlackRun=function(e,t,n,r){var i=Math.abs(r-t)>Math.abs(n-e);if(i){var s=e;e=t;t=s;s=n;n=r;r=s}var o=Math.abs(n-e);var u=Math.abs(r-t);var a=-o>>1;var f=t<r?1:-1;var l=e<n?1:-1;var c=0;for(var h=e,p=t;h!=n;h+=l){var d=i?p:h;var v=i?h:p;if(c==1){if(this.image[d+v*qrcode.width]){c++}}else{if(!this.image[d+v*qrcode.width]){c++}}if(c==3){var m=h-e;var g=p-t;return Math.sqrt(m*m+g*g)}a+=u;if(a>0){if(p==r){break}p+=f;a-=o}}var y=n-e;var b=r-t;return Math.sqrt(y*y+b*b)};this.sizeOfBlackWhiteBlackRunBothWays=function(e,t,n,r){var i=this.sizeOfBlackWhiteBlackRun(e,t,n,r);var s=1;var o=e-(n-e);if(o<0){s=e/(e-o);o=0}else if(o>=qrcode.width){s=(qrcode.width-1-e)/(o-e);o=qrcode.width-1}var u=Math.floor(t-(r-t)*s);s=1;if(u<0){s=t/(t-u);u=0}else if(u>=qrcode.height){s=(qrcode.height-1-t)/(u-t);u=qrcode.height-1}o=Math.floor(e+(o-e)*s);i+=this.sizeOfBlackWhiteBlackRun(e,t,o,u);return i-1};this.calculateModuleSizeOneWay=function(e,t){var n=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(e.X),Math.floor(e.Y),Math.floor(t.X),Math.floor(t.Y));var r=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(t.X),Math.floor(t.Y),Math.floor(e.X),Math.floor(e.Y));if(isNaN(n)){return r/7}if(isNaN(r)){return n/7}return(n+r)/14};this.calculateModuleSize=function(e,t,n){return(this.calculateModuleSizeOneWay(e,t)+this.calculateModuleSizeOneWay(e,n))/2};this.distance=function(e,t){xDiff=e.X-t.X;yDiff=e.Y-t.Y;return Math.sqrt(xDiff*xDiff+yDiff*yDiff)};this.computeDimension=function(e,t,n,r){var i=Math.round(this.distance(e,t)/r);var s=Math.round(this.distance(e,n)/r);var o=(i+s>>1)+7;switch(o&3){case 0:o++;break;case 2:o--;break;case 3:throw"Error"}return o};this.findAlignmentInRegion=function(e,t,n,r){var i=Math.floor(r*e);var s=Math.max(0,t-i);var o=Math.min(qrcode.width-1,t+i);if(o-s<e*3){throw"Error"}var u=Math.max(0,n-i);var a=Math.min(qrcode.height-1,n+i);var f=new AlignmentPatternFinder(this.image,s,u,o-s,a-u,e,this.resultPointCallback);return f.find()};this.createTransform=function(e,t,n,r,i){var s=i-3.5;var o;var u;var a;var f;if(r!=null){o=r.X;u=r.Y;a=f=s-3}else{o=t.X-e.X+n.X;u=t.Y-e.Y+n.Y;a=f=s}var l=PerspectiveTransform.quadrilateralToQuadrilateral(3.5,3.5,s,3.5,a,f,3.5,s,e.X,e.Y,t.X,t.Y,o,u,n.X,n.Y);return l};this.sampleGrid=function(e,t,n){var r=GridSampler;return r.sampleGrid3(e,n,t)};this.processFinderPatternInfo=function(e){var t=e.TopLeft;var n=e.TopRight;var r=e.BottomLeft;var i=this.calculateModuleSize(t,n,r);if(i<1){throw"Error"}var s=this.computeDimension(t,n,r,i);var o=Version.getProvisionalVersionForDimension(s);var u=o.DimensionForVersion-7;var a=null;if(o.AlignmentPatternCenters.length>0){var f=n.X-t.X+r.X;var l=n.Y-t.Y+r.Y;var c=1-3/u;var h=Math.floor(t.X+c*(f-t.X));var p=Math.floor(t.Y+c*(l-t.Y));for(var d=4;d<=16;d<<=1){a=this.findAlignmentInRegion(i,h,p,d);break}}var v=this.createTransform(t,n,r,a,s);var m=this.sampleGrid(this.image,v,s);var g;if(a==null){g=new Array(r,t,n)}else{g=new Array(r,t,n,a)}return new DetectorResult(m,g)};this.detect=function(){var e=(new FinderPatternFinder).findFinderPattern(this.image);return this.processFinderPatternInfo(e)}}PerspectiveTransform.quadrilateralToQuadrilateral=function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=this.quadrilateralToSquare(e,t,n,r,i,s,o,u);var g=this.squareToQuadrilateral(a,f,l,c,h,p,d,v);return g.times(m)};PerspectiveTransform.squareToQuadrilateral=function(e,t,n,r,i,s,o,u){dy2=u-s;dy3=t-r+s-u;if(dy2==0&&dy3==0){return new PerspectiveTransform(n-e,i-n,e,r-t,s-r,t,0,0,1)}else{dx1=n-i;dx2=o-i;dx3=e-n+i-o;dy1=r-s;denominator=dx1*dy2-dx2*dy1;a13=(dx3*dy2-dx2*dy3)/denominator;a23=(dx1*dy3-dx3*dy1)/denominator;return new PerspectiveTransform(n-e+a13*n,o-e+a23*o,e,r-t+a13*r,u-t+a23*u,t,a13,a23,1)}};PerspectiveTransform.quadrilateralToSquare=function(e,t,n,r,i,s,o,u){return this.squareToQuadrilateral(e,t,n,r,i,s,o,u).buildAdjoint()}